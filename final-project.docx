                               计算机图形学实验4：ray tracing
陈玄烨
一.功能说明
	此渲染器名为RenderCraft,是我从大一暑假的第一版开始断断续续迭代而成（在github上可以看到早前的版本），中间也参考了其他的渲染器实现，其中受PBRT-V3，lajolla（CSE272-Advanced Image Synthesis课程的渲染器）启发较大。如果不出意外，我想这个小系统可能将发展成我将来的毕设的一部分了。
	此渲染器仍然很不完善，目前支持的功能如下：
	1. 积分器：支持了普通的路径追踪积分器，以及体积路径追踪积分器，其中后者是我由CSE272的作业移植而来，尚不支持环境光照。
	2. 加速结构：支持了Linear BVH，在测试场景中已经使用上了该加速结构，应当是正确的。
	3. 几何：只支持球体和三角网格
	4. 材质：目前编写了Lambertian材质，基于Trowbridge Heitz微表面模型的金属材质以及透明绝缘材质，其中后两者曾经是支持的，在重构过程中正确性已经无法保证。
	5. 参与介质：支持了使用网格体积纹理表示的参与介质，能够进行体积渲染。
	6. 纹理：支持较少，主要是不会写光线微分，不太好做纹理滤波。

二. 外部依赖/哪些代码是别人写的
	使用glm作为几何库（早期版本中使用我自己写的向量运算，后来改了），tinyexr用于将渲染结果导出为exr图片，pugi_xml用于解析xml文件（实际由于场景解析出问题了，并没有使用上），TBB用于CPU上的并行加速（我自己系统上是装了TBB的，如果没有TBB的话把用到TBB的循环改成顺序循环就可以了）。
	我使用的外部代码有：lajolla中的obj-loader（因为obj文件都是从lajolla扒出来的，使用原来自己写的那个解析不了这些obj中更复杂的东西）以及rgb-spectrum转换代码（非常的固定，照着论文就可以把式子写出来，实际上lajolla本身也是偷懒复制了别人的）。除此以外的剩余全部代码由我自己完成。

二. 使用
	目前由于我本机上的正则表达式标准库出现问题，场景解析的部分无法编译（实际上我也来不及让场景解析支持这么多功能），因此使用了一个硬编码场景，一样按照cmake的流程进行编译得到rdcraft可执行文件，直接运行便可在可执行文件的目录下生成名为output.exr的文件，在release模式下编译并开启并行加速的情况下，渲染的速度还是不算很慢，spp取到2048时大约在几分钟内可以出结果。

三. 体积数据的获取
	在本demo中使用的体积数据来源于我自己编写的GPU烟雾模拟器，其功能很不完善，但是已经可以得到能看的体积数据，由于与光线追踪本身关联不大，没有附加于本实验代码中。烟雾模拟器本身是我自己的项目SimCraft的一个子模块，github仓库为https://github.com/CLV-Iclucia/SimCraft。
	SimCraft中包含其他诸多模块（但是毛发，MPM未完成，自由液面模拟器目前也未完成调试，也就是说GPU-Smoke是唯一能用的...）。
	GPU-Smoke使用cuda编写，因此需要Nvidia显卡以及适当版本的cuda。
	同样使用CMake的流程构建出gpu-smoke，即可按照预设参数开始运行，运行时会弹出一个窗口用于预览烟雾，按下P即可在此刻暂停运行并将烟雾体积数据导出至当前可执行文件所在目录下。
	此外，也可以通过指定命令行参数来指明需要在哪一帧将数据导出，结合此功能与渲染器可以编写自动化脚本制作简易的烟雾动画（我不知道怎么把一串图片转成视频所以没有做）。
 	烟雾使用纯欧拉视角进行模拟，方法是经典的Jos Stam的stable fluids，使用RK3进行半拉格朗日法advection的求解，使用400次暴力jacobi迭代用于求解projection。同时按照1999年的论文的方法给烟雾加入了涡量。


四. RenderCraft技术说明
	关于体积路径追踪技术，我在原来学习的时候写了一篇详尽的博客（https://clv-iclucia.github.io/2022/09/13/CSE-272-Hw/），介绍如何在lajolla基础上逐步实现一个还算比较完整的体积路径追踪积分器，目前视效上看似乎问题不大，在lajolla的给定场景下与参考图几乎没有区别，不过并不清楚是否完全正确。
	关于光源采样，我使用了alias sampling的方法，O(1)时间完成多光源的采样，但是在测试场景中只有一个光源。
	关于Linear BVH，我基本上是从PBRT学习的，不同的是PBRT使用的是HLBVH，也就是在LBVH子树之上再使用SAH进行构建，我由于不会SAH，就直接全部用LBVH构建到底了。
	
五. 尚存在且未解决的问题/未验证正确性的部分/还可以更进一步的部分
	灯在偏离中心的时候会变形，不知为何，也没有很好的解决。
	渲染出来的地面上没有烟雾的影子，虽然不清楚正不正确，但是感觉上这是不太正常的，可能是由于灯光太强。这套体积路径追踪代码在lajolla上工作时，除了lajolla本身相交测试存在的问题以外，至少是没有什么视觉上的不适的，可能是移植过程存在问题。
	对材质，纹理等的支持不充分，微表面模型在重构过程中没有验证正确性，有待后续测试。完全没有对次表面散射/分层材质的支持，有待后续继续学习实现。
	场景解析功能需要修复。
	更高级的双向光传输算法只留了个框架，有待后续的实现。

六. 致谢
	从最开始最简单的几百行路径追踪器，到现在一个虽然功能还很不完善但是已经有一点点儿规模的小渲染器，中间重构了很多很多次，走了很多弯路。同样的，物理模拟的学习也不是一帆风顺。这其中有很多人的帮助，才有了现在这么一个小系统。当然应该感谢的列表远远不止于此，下面是确实在这个系统的构建中。
	感谢以高林老师为首的图形学课程组在整个学期中的付出，也感谢你们带来了四个精彩的实验。
	感谢清华大学的郑少锟博士对我在渲染，cuda，性能优化以及工程实践等方面的帮助和指导。
	感谢合肥工业大学的王浩骅同学和我在离线渲染方面长期的交流和帮助，你的DreamRender以及你在离线渲染上表现出的极客精神一直是我学习的榜样。

七. 参考
	以下为实现本次作业过程中直接紧密关联的官方课程/书目/论文，其余关联不甚紧密的在此不列出了。
	1. https://cseweb.ucsd.edu/~tzli/cse272/wi2023/
	2. Physically Based Rendering, 3rd edition
	3. Physically Based Rendering, 4th edition
	4. Fluid Simulation for Computer Graphics, 2nd edition
	5. Visual Simulation of Smoke, SIGGRAPH 1999
	6. A null-scattering path integral formulation of light transport, SIGGRAPH 2019
	7. Simple Analytic Approximations to the CIE XYZ Color Matching Functions, SIGGRAPH 2013
